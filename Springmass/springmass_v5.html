<!DOCTYPE html>
<!-- Vivek T R Feb 2021 -->


<html>
<head>
	<!-- <meta http-equiv="content-type" content="text/html; charset=UTF8"> -->
	<title>Spring mass</title>
	<style>
		canvas {
			border: 2px solid black;
			height: 90% ;
			width: 100% ;
			/*background: rgba(255,255,255,0.1);*/
		}
		body {
			margin: 20;
		}
		/*SWITCH STYLING*/
		.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
		#mybox{ 
			background: rgba(255,255,255,1);
		}
	</style>
</head>


<body>

	<script> // INITIALIZING VARIABLES
		var stop=false;
		var sounds=false;
		var firstmouseaction = false;
		var count=0;
		function soundToggle(){
			firstmouseaction = true;
			sounds=!sounds;

			if (sounds){
							console.log(sounds); 
				console.log("Sound turned on");
			}else{
							console.log(sounds); 
				console.log("Sound turned off");
			}
		}
		function runToggle(){
			firstmouseaction = true;
			stop=!stop;

			if (stop){
				console.log('stop ', stop); 
				console.log("Run turned off");
			}else{
				console.log(stop); 
				console.log("Run turned on");
			}

		}
	</script>
	<div id='mybox'>

		<!-- <center style="font-size:20px"> -->
			<center>
			  <label class="switch" >
				<input type="checkbox" checked>
				<span class="slider round" onclick='runToggle()'></span>
			</label>

			 <label class="switch" >
				<input type="checkbox" >
				<span class="slider round" onclick='soundToggle()'></span>
			</label>
		</center>

	<canvas></canvas>
	</div>


	<!-- FULL SCREEN ON DOUBLECLICK SCRIPT -->
	<script>
	// checks if the window is already in fullscreen 
	// function getFullscreenElement(){ // returns true if in fullscreen
	// 	return document.fullscreenElement 
	// 	|| document.msFullscreenElement 
	// 	|| document.webkitFullscreenElement 
	// 	|| document.mozFullscreenElement;
	// }

	// DOUBLE CLICK TO GO TO FULLSCREEN
	document.addEventListener('dblclick',()=> {toggleFullscreen()})
	// TOGGLE FUNCTION between fullscreen and exit fullscreen
	function toggleFullscreen(){
	// 	if (getFullscreenElement()){// if it is in full screen 
	// 		//document.exitFullscreen(); // Exits fullscreen
	// 	}else {
				// ACTUAL COMMAND to go to full screen
			document.getElementById('mybox').requestFullscreen().catch(console.log);
	// 	}
	}
	// EVENT LISTENER to detect if the fullscreen has changed
	document.addEventListener('fullscreenchange',()=>{console.log('fullscreen changed')})
	// FULL SCREEN ON DOUBLE CLICK SCRIPT ENDS 
	</script>


<!-- <configuration>
    <nonFilteredFileExtensions>
    <nonFilteredFileExtension>ttf</nonFilteredFileExtension>
    <nonFilteredFileExtension>woff</nonFilteredFileExtension>
    <nonFilteredFileExtension>woff2</nonFilteredFileExtension>
    <nonFilteredFileExtension>eot</nonFilteredFileExtension>
    <nonFilteredFileExtension>svg</nonFilteredFileExtension>
    </nonFilteredFileExtensions>
 </configuration> -->

	<!-- <div> 
		
		<center>
			<button onclick='stop=false'>Start</button onclick>
			<button onclick='stop=true'>Stop</button>
			<button onclick='soundToggle()'}>Sound</button>
		</center>
	</div>  -->

	<script> // SPRING MASS SYSTEMS WITH DIFFERENT DAMPING

		// ------ BASICS OF CANVAS
		console.log('Pull the spring and release')
		// get the canvas by using query selector
		var canvas =document.querySelector('canvas');
		// changing the width and height of the canvas window
		canvas.width= window.innerWidth;
		canvas.height = window.innerHeight*0.9;
		// console.log(canvas)
		// getting the context of the canvas
		var c=canvas.getContext('2d');
		// c is going to be used so very often.






// GLOBAL VARIABLES
var mouse = {
	x: undefined,    y: undefined
}
var mousedrop = {
	x: undefined,    y: undefined
}
var mouseclick = {
	x: undefined,    y: undefined
}
// var x = 0;
// var y = 0;
var r = 0.05*canvas.width;
// var dx = 0;
// var dy = 0;
var dt = 0.1;
var meanposx = canvas.width/2; // mean position in x direction
var	meanposy = canvas.height/2; // mean position in y direction
var zeta = 0.0;
var k = 1; 
var m = 1;
var omega_n=Math.sqrt(k/m);
var springWidth=r*.5;
var mouseInfluence = 1.5*r;
var firstmouseaction = false;

// ADDING EVENT LISTENERS
// This will get be fired each time an event occurs
// An event may be a mouse 
// whenever there is a mouse move, this function is called
let drag = false; // on when mouse is kept pressed
let drop = false; // fires when mouse released


// MOUSE CLICK HOLD LISTENER
canvas.addEventListener('mousedown', (e) => {drag = false; 
	drag = true;
	mouseclick.x=e.x;
	mouseclick.y=e.y;

});
canvas.addEventListener('touchstart', (e) => {
	e.preventDefault();
	drag = true;
	mouseclick.x=e.touches[0].clientX;
	mouseclick.y=e.touches[0].clientY;
});


// MOUSE RELEASE LISTENER
canvas.addEventListener('mouseup', (e) => {
	drag=false;
	mousedrop.x=e.x;
	mousedrop.y=e.y;
});
canvas.addEventListener('touchend', (e) => {
	 // console.log(e)
	 e.preventDefault();
	// mousedrop.x=e.touches[0].clientX;
	// mousedrop.y=e.touches[0].clientY;
	mousedrop.x=mouse.x;
	mousedrop.y=mouse.y;
	// if (drag==false){
	// 	drop=true; 
	// } else{
	// 	drop = false;
	// }
	drag=false;
});

// MOUSE POSITION LISTENER
canvas.addEventListener('mousemove', (e) => {
	mouse.x=e.x;
	mouse.y=e.y;
});
canvas.addEventListener('touchmove', (e) => {
	e.preventDefault();
	mouse.x=e.touches[0].clientX;
	mouse.y=e.touches[0].clientY;
		//alert('Touch end, x value'+e.x)
	});



// SOUND PLAYER FROM URL
function sound(url1){
	if (sounds){
		var audio1= new Audio(url1)
		audio1.play();}
	}
// The above overloads sound on top of the one playing 
// spring sound url
let sound_url_spring='http://codeskulptor-demos.commondatastorage.googleapis.com/pang/arrow.mp3';



// DEFINING THE SPRING MASS OBJECT
function Mass(x,y,dy,m,k,zeta){
	// this.xfrac=x/innerWidth;
	// this.yfrac=y/innerHeight;
    this.x=x; // mean position in x
    this.y=y; // mean position in y
    this.dy=dy; // velocity in y
    this.m=m;
    this.k=k;
    this.zeta=zeta;
    this.omega_n=Math.sqrt(this.k/this.m);
    if (this.zeta<1){
    	this.omega_d=this.omega_n*Math.sqrt(1-this.zeta**2);
    	console.log('Underdamped system')
    }
    else if (this.zeta==1){
    	this.omega_d=0;
    	console.log('critically damped system')
    }
    else if(this.zeta>1){
    	this.omega_d=this.omega_n*Math.sqrt(this.zeta**2-1)
    }
    this.t=0;
    this.X0=this.y;
    this.V0=this.dy;
    // this.r=r; // radius of the circle
    // create a method inside the object
    // in this case an anonymous function without a name
    this.draw = function(){
		// Draw a spring
		c.beginPath();
		c.moveTo(this.x,meanposy+this.y+r/2);
		for(var i=0;i<=100;i++){
			c.lineTo(this.x+springWidth/2*Math.sin(i/100*10*Math.PI),meanposy+this.y+r/2+i/100*(meanposy-this.y-r/2));

		}
		c.strokeStyle = 'blue';
		c.lineWidth = 8;
		c.stroke();

        // Fill a rectangle
        c.fillStyle='rgba(255,50,50,0.8)' ;
        c.fillRect(this.x-r/2,meanposy+this.y-r/2,r,r)


        //  Write text M
        // c.font = r/2+ 'px';

        c.fillStyle='#000000' ;
        // c.textAlign='center';
        // c.fillText('M', this.x, meanposy+this.y+r/4);

                //  Write text zeta
                // c.font = r/3+ 'px';
                c.fillStyle='#000000' ;
                // c.textAlign='center';
                // c.fillText("\u03B6 " +' = '+ this.zeta, this.x,r,r);
                // c.fillText("zeta" +'  '+ this.zeta, this.x,r,r);

            }
            this.update = function(){
            	if (drag && (Math.abs(this.x-mouse.x)<mouseInfluence || mouse.x> 0.9*canvas.width ||mouse.x<0.1*canvas.width)){
    				// time marching method
    				this.y=mouse.y-meanposy;

    				// analytical method
    				this.X0=this.y;
    				this.V0=0;
    				this.t=0;
    				firstmouseaction=true;
    			}else if (stop==false){ // NO MOUSE HOLD DETECTED: CONTINUE ANIMATION AS PER PHYSICS

    				if (this.t==0 && firstmouseaction==true){
    					sound(sound_url_spring);
    				}
    				// TIME MARCHING METHOD
    				// // computing acceleration
  					// this.ddy=-Math.sqrt(this.k/this.m)*this.y-2*zeta*omega_n*this.dy;
  					// // computing velocity
  					//   	this.dy=this.dy+this.ddy*dt;
					// // Computing displacement
					// this.y=this.y+this.dy*dt+this.ddy/2*dt**2;

    				// ANALYTICAL METHOD
    				this.t=this.t+dt;
    				if (this.zeta<1){ // UNDER DAMPED
    					this.y=Math.exp(-this.zeta*this.omega_n*this.t)*(this.X0*Math.cos(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sin(this.omega_d*this.t));
    				}else if(this.zeta==1){ // CRITICAL DAMPING
    					this.y=Math.exp(-this.omega_n*this.t)*(this.X0+this.t*(this.V0+this.omega_n*this.X0));

    				}else if(this.zeta>1){ // OVERDAMPED
    				// To prevent NaNs running only upto t=1000
    				if (this.t<1000 && Math.abs(this.y)>0.01 && this.omega_n*this.t<40){
    					this.y=Math.exp(-this.zeta*this.omega_n*this.t)*(this.X0*Math.cosh(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sinh(this.omega_d*this.t));
    						// console.log(this.y);
    						//console.log(this.t+' '+ Math.abs(this.y))
    					}else{ 
    					//console.log(this.t<1000,Math.abs(this.y)>0.001,this.omega_n*this.t<100);
    					//console.log(Math.exp(-this.zeta*this.omega_n*this.t),(this.X0*Math.cosh(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sinh(this.omega_d*this.t)))
    					// escape condition for numerical inaccuracy when multiplying 0 and -Infinity
    					//this.y=0;
    				}
    			}

    		}
    		this.draw();
    	}

    }

function wasFetchedViaSpdy() {
  // SPDY is deprecated in favor of HTTP/2, but this implementation returns
  // true for HTTP/2 or HTTP2+QUIC/39 as well.
  if (window.PerformanceNavigationTiming) {
    const ntEntry = performance.getEntriesByType('navigation')[0];
    return ['h2', 'hq'].includes(ntEntry.nextHopProtocol);
  }
}

// Creating a new mass object
// syntax for Mass(x,y,dy,m,k,zeta)
// var ball = new Mass(8*r,-r,0,1,1,2);
var ball1 = new Mass(0.2*canvas.width,-r,0,1,1,0);
var ball2 = new Mass(0.3*canvas.width,-r,0,1,1,0.02);
var ball3 = new Mass(0.4*canvas.width,-r,0,1,1,0.1);
var ball4 = new Mass(0.5*canvas.width,-r,0,1,1,0.8);
var ball5 = new Mass(0.6*canvas.width,-r,0,1,1,1);
var ball6 = new Mass(0.7*canvas.width,-r,0,1,1,2);
var ball7 = new Mass(0.8*canvas.width,-r,0,1,1,10);


// Event listener for window resizing
window.addEventListener('resize',
	function(event){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight*.9;
        meanposx = canvas.width/2; // mean position in x direction
		meanposy = canvas.height/2; // mean position in y direction
		console.log('Window resized')
		// ball.update();
		ball1.update();
		ball2.update();
		ball3.update();
		ball4.update();
		ball5.update();
		ball6.update();
		ball7.update();




	})





// Actual animation
function animate(){  

	c.clearRect(0,0,canvas.width,canvas.height)
		// ball.update();
		ball1.update();
		ball2.update();
		ball3.update();
		ball4.update();
		ball5.update();
		ball6.update();
		ball7.update();


	// Writing common text
	// c.font = r/3+ 'px';
	c.fillStyle='#000000' ;
	// c.textAlign='center';

	// c.fillText("Spring mass systems with different damping ratios", canvas.width/2,r/2);

	requestAnimationFrame(animate);

	// console.log('Animating')
}
// calling the animation
animate();

</script>

</body>
</html>

