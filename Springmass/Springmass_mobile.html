<!DOCTYPE html>
<html>
<head>
	<!-- <meta http-equiv="content-type" content="text/html; charset=UTF8"> -->
	<title>Spring mass</title>
	<style type="text/css">
		canvas {
			border: 2px solid black;
			height: 100% ;
			width: 100% ;
			background: rgba(255,255,255,0.1);
		}
		body {
			margin: 10;
			background: rgba(255,255,255,0.1);
		}
		button{
			height: 20px;
		}
				#mybox{ 
			border: 2px solid black;
			height: 100% ;
			width: 100% ;
			background: rgba(255,255,255,1);
		}
	</style>
</head>
<body>
	<script>
		var stop=false;
		var sounds=false;
		function soundToggle(){
			sounds=!sounds;
			console.log(sounds); 
			if (sounds){
				console.log("Sound turned on");
			}
			else{
				console.log("Sound turned off");
			}
		}
	</script>
 <div id='mybox'>
	<center>
		<button onclick='stop=false'>START</button onclick>
		<button onclick='stop=true'>STOP</button>
		<button onclick='soundToggle()'}>SOUNDS</button>
	</center>
 
  <canvas>
  </canvas>
  <div>

  <!-- FULL SCREEN ON DOUBLECLICK SCRIPT -->
  <script type="text/javascript">
  // checks if the window is already in fullscreen 
  function getFullscreenElement(){ // returns true if in fullscreen
   return document.fullscreenElement 
   || document.msFullscreenElement 
   || document.webkitFullscreenElement 
   || document.mozFullscreenElement;
  }

  // DOUBLE CLICK TO GO TO FULLSCREEN
  document.addEventListener('dblclick',()=> {toggleFullscreen()})
  // TOGGLE FUNCTION between fullscreen and exit fullscreen
  function toggleFullscreen(){
  //  if (getFullscreenElement()){// if it is in full screen 
  //    //document.exitFullscreen(); // Exits fullscreen
  //  }else {
        // ACTUAL COMMAND to go to full screen
      document.getElementById('mybox').requestFullscreen().catch(console.log);
  //  }
  }
  // EVENT LISTENER to detect if the fullscreen has changed
  document.addEventListener('fullscreenchange',()=>{console.log('fullscreen changed')})
  // FULL SCREEN ON DOUBLE CLICK SCRIPT ENDS 
  </script>

	<script>
		// This is a canvas tutorial

		// ------ BASICS OF CANVAS
		console.log('Pull the spring and release')
		// get the canvas by using query selector
		var canvas =document.querySelector('canvas');
		// changing the width and height of the canvas window
		canvas.width= window.innerWidth;
		canvas.height = window.innerHeight;
		// console.log(canvas)
		// getting the context of the canvas
		var c=canvas.getContext('2d');
		// c is going to be used so very often.






// GLOBAL VARIABLES
var mouse = {
	x: undefined,    y: undefined
}
var mousedrop = {
	x: undefined,    y: undefined
}
var mouseclick = {
	x: undefined,    y: undefined
}
// var x = 0;
// var y = 0;
var r = 0.05*canvas.width;
// var dx = 0;
// var dy = 0;
var dt = 0.1;
var meanposx = innerWidth/2; // mean position in x direction
var	meanposy = innerHeight/2; // mean position in y direction
var zeta = 0.0;
var k = 1; 
var m = 1;
var omega_n=Math.sqrt(k/m);
var springWidth=r*.5;
var mouseInfluence = 1.5*r;
var firstmouseaction = false;

// ADDING EVENT LISTENERS
// This will get be fired each time an event occurs
// An event may be a mouse 
// whenever there is a mouse move, this function is called
let dragToggle = false; // on when mouse is kept pressed
let drop = false; // fires when mouse released


// MOUSE CLICK HOLD LISTENER
canvas.addEventListener('mousedown', (e) => {dragToggle = false; 
	dragToggle = true;
	mouseclick.x=e.x;
	mouseclick.y=e.y;

});
canvas.addEventListener('touchstart', (e) => {
	e.preventDefault();
	dragToggle = true;
	mouseclick.x=e.touches[0].clientX;
	mouseclick.y=e.touches[0].clientY;
});


// MOUSE RELEASE LISTENER
canvas.addEventListener('mouseup', (e) => {
	dragToggle=false;
	mousedrop.x=e.x;
	mousedrop.y=e.y;
});
canvas.addEventListener('touchend', (e) => {
	 // console.log(e)
	 e.preventDefault();
	// mousedrop.x=e.touches[0].clientX;
	// mousedrop.y=e.touches[0].clientY;
	mousedrop.x=mouse.x;
	mousedrop.y=mouse.y;
	// if (dragToggle==false){
	// 	drop=true; 
	// } else{
	// 	drop = false;
	// }
	dragToggle=false;
});

// MOUSE POSITION LISTENER
canvas.addEventListener('mousemove', (e) => {
	mouse.x=e.x;
	mouse.y=e.y;
});
canvas.addEventListener('touchmove', (e) => {
	e.preventDefault();
	mouse.x=e.touches[0].clientX;
	mouse.y=e.touches[0].clientY;
		//alert('Touch end, x value'+e.x)
	});



// SOUND PLAYER FROM URL
function sound(url1){
	if (sounds){
	var audio1= new Audio(url1)
	audio1.play();}
}
// The above overloads sound on top of the one playing 
// spring sound url
let sound_url_spring='http://codeskulptor-demos.commondatastorage.googleapis.com/pang/arrow.mp3';



// DEFINING THE SPRING MASS OBJECT
function Mass(x,y,dy,m,k,zeta){
	// this.xfrac=x/innerWidth;
	// this.yfrac=y/innerHeight;
    this.x=x; // mean position in x
    this.y=y; // mean position in y
    this.dy=dy; // velocity in y
    this.m=m;
    this.k=k;
    this.zeta=zeta;
    this.omega_n=Math.sqrt(this.k/this.m);
    if (this.zeta<1){
    	this.omega_d=this.omega_n*Math.sqrt(1-this.zeta**2);
    	console.log('Underdamped system')
    }
    else if (this.zeta==1){
    	this.omega_d=0;
    	console.log('critically damped system')
    }
    else if(this.zeta>1){
    	this.omega_d=this.omega_n*Math.sqrt(this.zeta**2-1)
    }
    this.t=0;
    this.X0=this.y;
    this.V0=this.dy;
    // this.r=r; // radius of the circle
    // create a method inside the object
    // in this case an anonymous function without a name
    this.draw = function(){
		// Draw a spring
		c.beginPath();
		c.moveTo(this.x,meanposy+this.y+r/2);
		for(var i=0;i<=100;i++){
			c.lineTo(this.x+springWidth/2*Math.sin(i/100*10*Math.PI),meanposy+this.y+r/2+i/100*(meanposy-this.y-r/2));

		}
		c.strokeStyle = 'blue';
		c.lineWidth = 8;
		c.stroke();

        // Fill a rectangle
        c.fillStyle='rgba(255,50,50,0.8)' ;
        c.fillRect(this.x-r/2,meanposy+this.y-r/2,r,r)


        //  Write text M
        c.font = r/2+ 'px Arial';
        c.fillStyle='#000000' ;
        c.textAlign='center';
        c.fillText('M', this.x, meanposy+this.y+r/4);

                //  Write text zeta
                c.font = r/3+ 'px Arial';
                c.fillStyle='#000000' ;
                c.textAlign='center';
                c.fillText("\u03B6 " +' = '+ this.zeta, this.x,r,r);

            }
            this.update = function(){
            	if (dragToggle && (Math.abs(this.x-mouse.x)<mouseInfluence || mouse.x> 0.9*canvas.width ||mouse.x<0.1*canvas.width)){
    				// time marching method
    				this.y=mouse.y-meanposy;

    				// analytical method
    				this.X0=this.y;
    				this.V0=0;
    				this.t=0;
    				firstmouseaction=true;
    			}else if (stop==false){ // NO MOUSE HOLD DETECTED: CONTINUE ANIMATION AS PER PHYSICS

    				if (this.t==0 && firstmouseaction==true){
    					sound(sound_url_spring);
    				}
    				// TIME MARCHING METHOD
    				// // computing acceleration
  					// this.ddy=-Math.sqrt(this.k/this.m)*this.y-2*zeta*omega_n*this.dy;
  					// // computing velocity
  					//   	this.dy=this.dy+this.ddy*dt;
					// // Computing displacement
					// this.y=this.y+this.dy*dt+this.ddy/2*dt**2;

    				// ANALYTICAL METHOD
    				this.t=this.t+dt;
    				if (this.zeta<1){ // UNDER DAMPED
    					this.y=Math.exp(-this.zeta*this.omega_n*this.t)*(this.X0*Math.cos(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sin(this.omega_d*this.t));
    				}else if(this.zeta==1){ // CRITICAL DAMPING
    					this.y=Math.exp(-this.omega_n*this.t)*(this.X0+this.t*(this.V0+this.omega_n*this.X0));

    				}else if(this.zeta>1){ // OVERDAMPED
    				// To prevent NaNs running only upto t=1000
    				if (this.t<1000 && Math.abs(this.y)>0.01 && this.omega_n*this.t<40){
    					this.y=Math.exp(-this.zeta*this.omega_n*this.t)*(this.X0*Math.cosh(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sinh(this.omega_d*this.t));
    						// console.log(this.y);
    						//console.log(this.t+' '+ Math.abs(this.y))
    				}else{ 
    					//console.log(this.t<1000,Math.abs(this.y)>0.001,this.omega_n*this.t<100);
    					//console.log(Math.exp(-this.zeta*this.omega_n*this.t),(this.X0*Math.cosh(this.omega_d*this.t)+(this.V0+this.zeta*this.omega_n*this.X0)/this.omega_d*Math.sinh(this.omega_d*this.t)))
    					// escape condition for numerical inaccuracy when multiplying 0 and -Infinity
    					//this.y=0;
    				}
    			}

			}
		this.draw();
	}

}

// Creating a new mass object
// syntax for Mass(x,y,dy,m,k,zeta)
// var ball = new Mass(8*r,-r,0,1,1,2);
var ball1 = new Mass(0.2*canvas.width,-r,0,1,1,0);
var ball2 = new Mass(0.3*canvas.width,-r,0,1,1,0.02);
var ball3 = new Mass(0.4*canvas.width,-r,0,1,1,0.1);
var ball4 = new Mass(0.5*canvas.width,-r,0,1,1,0.8);
var ball5 = new Mass(0.6*canvas.width,-r,0,1,1,1);
var ball6 = new Mass(0.7*canvas.width,-r,0,1,1,2);
var ball7 = new Mass(0.8*canvas.width,-r,0,1,1,10);


// Event listener for window resizing
window.addEventListener('resize',
	function(event){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
        meanposx = window.innerWidth/2; // mean position in x direction
		meanposy = window.innerHeight/2; // mean position in y direction
		console.log('Window resized')
		// ball.update();
		ball1.update();
		ball2.update();
		ball3.update();
		ball4.update();
		ball5.update();
		ball6.update();
		ball7.update();




	})



// Actual animation
function animate(){  

	c.clearRect(0,0,window.innerWidth,window.innerHeight)
		// ball.update();
		ball1.update();
		ball2.update();
		ball3.update();
		ball4.update();
		ball5.update();
		ball6.update();
		ball7.update();


	// Writing common text
	c.font = r/3+ 'px Arial';
	c.fillStyle='#000000' ;
	c.textAlign='center';
	c.fillText("Spring mass systems with different damping ratios", innerWidth/2,r/2);

	requestAnimationFrame(animate);

	// console.log('Animating')
}
// calling the animation
animate();

</script>
</body>
</html>

